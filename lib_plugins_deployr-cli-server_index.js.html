<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/plugins/deployr-cli-server/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/plugins/deployr-cli-server/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*!
 * Copyright (C) 2010-2015 by Revolution Analytics Inc.
 *
 * This program is licensed to you under the terms of Version 2.0 of the
 * Apache License. This program is distributed WITHOUT
 * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,
 * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the
 * Apache License 2.0 (http://www.apache.org/licenses/LICENSE-2.0) for more 
 * details.
 */

'use strict';

var deployr = require('deployr'),
    common  = require('flatiron').common;

/**
 * Top-level include for the `deployr-cli-server` module.
 *
 * @mixin
 * @alias plugins/deployr-cli-server
 */    
var cliServer = exports;

/**
 * Expose the plugin `commands`.
 */
cliServer.commands = require('./commands');

/**
 * Expose the plugin name _cli-server_.
 * @property {String} name - The plugin name.
 */
cliServer.name = 'cli-server';

/**
 * Attaches the `deployr-cli-server` behavior to the application.
 * @param {Object} options - The options object literal to use when attaching.
 */
cliServer.attach = function(options) {
    var app = this;
    options = options || {};

    if (!app.plugins.cli) {
        throw new Error('`cli` plugin is required to use `deployr-cli-server`');
    } else if (!app.config) {
        throw new Error('`app.config` must be set to use `deployr-cli-server`');
    }

    /**
     * Setup state from the application attached to. 
     * @property {Object} app - The application.
     */    
    cliServer.app = app;
    cliServer.after = options.after || {};
    cliServer.before = options.before || {};
    common.templateUsage(app, cliServer.commands);

    //
    // Add the necessary `&lt;app> server *` commands
    //
    app.commands['server'] = app.commands['server'] || {};
    app.commands['server'] = common.mixin(app.commands['server'], cliServer.commands);

    //
    // Setup aliases for `&lt;app> server *` commands.
    //
    app.alias('about', { // $ di about
        resource: 'server',
        command: 'about'
    });

    app.alias('endpoint', { // $ di endpoint
        resource: 'server',
        command: 'endpoint'
    });

    app.home = this.home;

    /**
     * Attempts to retrieve information about the DeployR server at the
     * supplied endpoint.
     *
     * @protected
     * @param {Function} callback - Continuation to pass control to when 
     * complete.     
     */
    app.about = function(callback) {
        var endpoint = app.config.get('endpoint') || null;

        if (endpoint) {            
            deployr.configure({ host: endpoint })
              .io('/r/server/info')
              .error(function(err) { callback(null, err); })
              .end(function(res) {                
                callback({ endpoint: endpoint, info: res.get('info') });
              });              
        } else {
            callback({});
        }
    };    

    /**
     * Attempts to set the DeployR server endpoint.
     *
     * @memberof plugins/deployr-cli-server    
     * @protected
     * @param {Function} callback - Continuation to pass control to when 
     * complete.     
     */    
    app.setEndpoint = function(callback) {
        var server   = {},
            regx     = new RegExp('^(http|https)://', 'i'),
            endpoint = app.config.get('endpoint') || null,
            errorMsg = ' Please enter a valid DeployR endpoint.',
            hostMsg  = (!endpoint ? ' http(s)://dhost:port' : '');

        app.prompt.inquirer([{
            name: 'endpoint',
            type: 'input',
            default: endpoint,
            message: 'DeployR Server' + app.chalk.dim.yellow(hostMsg) + ':',
            validate: function(input) {
                var done = this.async();
                if (input.length > 0) {
                	// Be more forgiving on the entered DeployR 'endpoint':
                    //   - http(s)://dhost:port
                    //   - http(s)://dhost:port/deployr
                    //   - dhost:port
                    //   - dhost:port/deployr
                    input = input.replace(/\/*$|\/*deployr\/*$/, '');
                    input = regx.test(input) ? input : 'http://' + input;

                    deployr.configure({ host: input })
                        .io('/r/server/info')
                        .error(function(err) {
                            deployr.configure({ host: '' });
                            done(errorMsg);
                        })
                        .end(function(res) {
                        	server = { endpoint: input, info: res.get('info') };
                            done(true);
                        });
                } else {
                    done(errorMsg);
                }
            }
        }], function() {
            callback(server);
        });    
    };
};

/**
 * Detaches this plugin from the application.
 */
cliServer.detach = function() {
    var app = this;

    Object.keys(app.commands['server']).forEach(function(method) {
        if (cliServer.commands[method]) {
            delete app.commands['config'][method];
        }

        cliServer.commands.app = null;
    });
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-deployr-cli.html">deployr-cli</a></li></ul><h3>Mixins</h3><ul><li><a href="commands_install.html">commands/install</a></li><li><a href="plugins_deployr-cli-server.html">plugins/deployr-cli-server</a></li><li><a href="plugins_deployr-cli-server_commands.html">plugins/deployr-cli-server/commands</a></li><li><a href="plugins_deployr-cli-users.html">plugins/deployr-cli-users</a></li><li><a href="plugins_deployr-cli-users_commands.html">plugins/deployr-cli-users/commands</a></li><li><a href="plugins_inquirer.html">plugins/inquirer</a></li><li><a href="util_brand.html">util/brand</a></li><li><a href="util_clear.html">util/clear</a></li><li><a href="util_lang-type.html">util/lang-type</a></li><li><a href="util_spawn-command.html">util/spawn-command</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta3</a> on Fri Apr 24 2015 12:14:58 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
